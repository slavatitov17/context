import { NextRequest, NextResponse } from 'next/server';
import { Mistral } from '@mistralai/mistralai';

// ะะฝะธัะธะฐะปะธะทะฐัะธั Mistral AI ะบะปะธะตะฝัะฐ
function getMistralClient(): Mistral | null {
  const apiKey = process.env.MISTRAL_API_KEY;
  if (!apiKey) {
    return null;
  }
  return new Mistral({ apiKey });
}

// ะคัะฝะบัะธั ะดะปั ะฟะพะปััะตะฝะธั ะบะพะฝัะตะบััะฐ ะธะท ะดะพะบัะผะตะฝัะพะฒ
function getContextFromDocuments(documents: any[]): string {
  const allChunks: string[] = [];
  documents.forEach((doc: any) => {
    if (doc.chunks && Array.isArray(doc.chunks)) {
      allChunks.push(...doc.chunks);
    } else if (doc.text) {
      const chunkSize = 1000;
      for (let i = 0; i < doc.text.length; i += chunkSize) {
        allChunks.push(doc.text.substring(i, i + chunkSize));
      }
    }
  });
  return allChunks.join('\n\n---\n\n');
}

export async function POST(request: NextRequest) {
  try {
    const body = await request.json();
    const { diagramType, objectDescription, documents, isFromProject } = body;

    if (!diagramType || typeof diagramType !== 'string') {
      return NextResponse.json(
        { error: 'ะขะธะฟ ะดะธะฐะณัะฐะผะผั ะฝะต ะฟัะตะดะพััะฐะฒะปะตะฝ' },
        { status: 400 }
      );
    }

    if (!objectDescription || typeof objectDescription !== 'string') {
      return NextResponse.json(
        { error: 'ะะฟะธัะฐะฝะธะต ะพะฑัะตะบัะฐ ะฝะต ะฟัะตะดะพััะฐะฒะปะตะฝะพ' },
        { status: 400 }
      );
    }

    // ะะพะปััะฐะตะผ ะบะปะธะตะฝั Mistral AI
    const client = getMistralClient();

    if (!client) {
      return NextResponse.json(
        { error: 'Mistral AI API ะบะปัั ะฝะต ะฝะฐัััะพะตะฝ. ะฃััะฐะฝะพะฒะธัะต MISTRAL_API_KEY ะฒ ะฟะตัะตะผะตะฝะฝัั ะพะบััะถะตะฝะธั.' },
        { status: 500 }
      );
    }

    // ะคะพัะผะธััะตะผ ะบะพะฝัะตะบัั ะธะท ะดะพะบัะผะตะฝัะพะฒ (ะตัะปะธ ะตััั)
    let context = '';
    if (isFromProject && documents && Array.isArray(documents) && documents.length > 0) {
      context = getContextFromDocuments(documents);
    }

    // ะัะพะฒะตััะตะผ, ัะฒะปัะตััั ะปะธ ััะพ Mermaid ะดะธะฐะณัะฐะผะผะพะน
    const isMermaid = diagramType === 'MindMapMermaid' || 
                      diagramType === 'MindMapMax' ||
                      diagramType === 'SequenceMermaid' ||
                      diagramType === 'ClassMermaid' ||
                      diagramType === 'StateMermaid' ||
                      diagramType === 'ActivityMermaid' ||
                      diagramType === 'GanttMermaid' ||
                      diagramType === 'ERMermaid' ||
                      diagramType === 'Architecture' ||
                      diagramType === 'C4' ||
                      diagramType === 'Git' ||
                      diagramType === 'Kanban' ||
                      diagramType === 'Pie' ||
                      diagramType === 'Quadrant' ||
                      diagramType === 'Radar' ||
                      diagramType === 'Timeline' ||
                      diagramType === 'UserJourney' ||
                      diagramType === 'XY';

    // ะะฟัะตะดะตะปัะตะผ ัะธะฟ Mermaid ะดะธะฐะณัะฐะผะผั
    const getMermaidDiagramType = (type: string): string => {
      if (type === 'MindMapMermaid' || type === 'MindMapMax') return 'mindmap';
      if (type === 'SequenceMermaid') return 'sequenceDiagram';
      if (type === 'ClassMermaid') return 'classDiagram';
      if (type === 'StateMermaid') return 'stateDiagram-v2';
      if (type === 'ActivityMermaid') return 'flowchart';
      if (type === 'GanttMermaid') return 'gantt';
      if (type === 'ERMermaid') return 'erDiagram';
      if (type === 'Architecture') return 'graph';
      if (type === 'C4') return 'C4Context';
      if (type === 'Git') return 'gitGraph';
      if (type === 'Kanban') return 'kanban';
      if (type === 'Pie') return 'pie';
      if (type === 'Quadrant') return 'quadrantChart';
      if (type === 'Radar') return 'radar';
      if (type === 'Timeline') return 'timeline';
      if (type === 'UserJourney') return 'journey';
      if (type === 'XY') return 'xychart-beta';
      return 'mindmap';
    };

    // ะคัะฝะบัะธั ะดะปั ะฟะพะปััะตะฝะธั ะดะตัะฐะปัะฝัั ะธะฝััััะบัะธะน ะฟะพ ัะธะฝัะฐะบัะธัั ะดะปั ะบะฐะถะดะพะณะพ ัะธะฟะฐ ะดะธะฐะณัะฐะผะผั
    const getMermaidSyntaxInstructions = (type: string, diagramType: string): string => {
      // ะกะฟะตัะธะฐะปัะฝะฐั ัะฐััะธัะตะฝะฝะฐั ะธะฝััััะบัะธั ะดะปั MindMapMax
      if (type === 'MindMapMax') {
        return `๐จ๐จ๐จ ะะะะขะะงะะกะะ ะะะะะ ะะะฏ MINDMAP - ะงะะขะะ ะะะะะะขะะะฌะะ! ๐จ๐จ๐จ

ะขะซ ะะะะะะ ะกะะะะะขะฌ ะะะกะะะฎะขะะ ะะะะะะะฌะะซะ ะะะ MINDMAP ะะะ ะะจะะะะ!

โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
ะะะะะะะ #1: ะกะะะขะะะกะะก - ะกะขะะะะ ะะะฏะะะขะะะฌะะ!
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
- ะะะะะะฏ ะกะขะะะะ ะะะะ: ะขะะงะะ "mindmap" ะะะ ะะะะะะะะ, ะะะ ะะขะกะขะฃะะะ!
- ะะะะะะะะะฌะะ: "  mindmap" ะธะปะธ "\\n  mindmap" ะธะปะธ " mindmap"
- ะะะะะะะฌะะ: "mindmap" (ะฝะฐ ะฟะตัะฒะพะน ัััะพะบะต, ะฑะตะท ะฟัะพะฑะตะปะพะฒ ะฒะพะพะฑัะต!)

โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
ะะะะะะะ #2: ะะขะกะขะฃะะซ - ะญะขะ ะะะะขะะงะะ! ะะะ ะะะะะะะฌะะซะฅ ะะขะกะขะฃะะะ ะะะ ะะ ะะะะะขะะะข!
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
- ะะกะะะะฌะะฃะ ะขะะะฌะะ ะะะะะะะซ! ะะะะะะะ ะะ ะะกะะะะฌะะฃะ ะขะะะฃะะฏะฆะะฎ (TAB)!
- ะกะขะะะะ 1: "mindmap" (0 ะฟัะพะฑะตะปะพะฒ)
- ะกะขะะะะ 2: ะบะพัะฝะตะฒะพะน ัะทะตะป ั ะะะะะ 2 ะะะะะะะะะ ะพััััะฟะฐ
- ะกะขะะะะ 3+: ะบะฐะถะดัะน ัะปะตะดัััะธะน ััะพะฒะตะฝั = +2 ะะะะะะะ ะพั ะฟัะตะดัะดััะตะณะพ

ะกะขะะะะะฏ ะกะฅะะะ ะะขะกะขะฃะะะ:
mindmap                    โ 0 ะฟัะพะฑะตะปะพะฒ
  root((ะะพัะฝะตะฒะพะน ัะทะตะป))    โ 2 ะฟัะพะฑะตะปะฐ (ะะะฏะะะขะะะฌะะ!)
    ะะพะดัะตะผะฐ 1              โ 4 ะฟัะพะฑะตะปะฐ (2+2)
      ะะตัะฐะปั 1.1           โ 6 ะฟัะพะฑะตะปะพะฒ (4+2)
        ะะพะดะดะตัะฐะปั 1.1.1    โ 8 ะฟัะพะฑะตะปะพะฒ (6+2)
      ะะตัะฐะปั 1.2           โ 6 ะฟัะพะฑะตะปะพะฒ (ะฒะพะทะฒัะฐั ะฝะฐ ััะพะฒะตะฝั)
    ะะพะดัะตะผะฐ 2              โ 4 ะฟัะพะฑะตะปะฐ (ะฒะพะทะฒัะฐั ะฝะฐ ััะพะฒะตะฝั)

ะะะะะะะะะฌะะ (ะฒัะทะพะฒะตั ะพัะธะฑะบั!):
mindmap
root((ะะพัะฝะตะฒะพะน ัะทะตะป))      โ ะะะข ะะขะกะขะฃะะ! ะะจะะะะ!
  ะะพะดัะตะผะฐ 1                โ ะัะฐะฒะธะปัะฝะพ
ะะพะดัะตะผะฐ 2                   โ ะะะข ะะขะกะขะฃะะ! ะะจะะะะ "No parent could be found"!

โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
ะะะะะะะ #3: ะะะะะะะะ ะฃะะะ - ะขะะะฌะะ ะะะะ! ะะะ ะะกะะะฎะงะะะะ!
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
- ะ MindMap ะะะะะข ะะซะขะฌ ะขะะะฌะะ ะะะะ ะบะพัะฝะตะฒะพะน ัะทะตะป!
- ะะพัะฝะตะฒะพะน ัะทะตะป ะะะฏะะะขะะะฌะะ ะฝะฐ ะฒัะพัะพะน ัััะพะบะต ั ะพััััะฟะพะผ ะะะะะ 2 ะะะะะะะ
- ะคะพัะผะฐั: "  root((ะะฐะทะฒะฐะฝะธะต))" ะธะปะธ ะฟัะพััะพ "  ะะฐะทะฒะฐะฝะธะต"
- ะัะปะธ ะฒ ะพะฟะธัะฐะฝะธะธ ะฝะตัะบะพะปัะบะพ ะพัะฝะพะฒะฝัั ัะตะผ โ ะฒัะฑะตัะธ ะะะะฃ ะณะปะฐะฒะฝัั ะบะฐะบ ะบะพัะฝะตะฒะพะน ัะทะตะป, ะพััะฐะปัะฝัะต ัะดะตะปะฐะน ะฟะพะดัะตะผะฐะผะธ ะฟะตัะฒะพะณะพ ััะพะฒะฝั (4 ะฟัะพะฑะตะปะฐ)

ะะะะะะะะะฌะะ (ะฒัะทะพะฒะตั ะพัะธะฑะบั "There can be only one root"):
mindmap
  root((ะขะตะผะฐ 1))
  root((ะขะตะผะฐ 2))            โ ะะจะะะะ! ะะฒะฐ ะบะพัะฝะตะฒัั ัะทะปะฐ!

ะะะะะะะฌะะ:
mindmap
  root((ะะปะฐะฒะฝะฐั ัะตะผะฐ))
    ะขะตะผะฐ 1                  โ ะะพะดัะตะผะฐ ะฟะตัะฒะพะณะพ ััะพะฒะฝั (4 ะฟัะพะฑะตะปะฐ)
    ะขะตะผะฐ 2                  โ ะะพะดัะตะผะฐ ะฟะตัะฒะพะณะพ ััะพะฒะฝั (4 ะฟัะพะฑะตะปะฐ)

โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
ะะะะะะะ #4: ะะะะะะฅะะฏ - ะะะะะซะ ะฃะะะ ะะะะะะ ะะะะขะฌ ะะะะะขะะะฏ!
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
- ะะพัะฝะตะฒะพะน ัะทะตะป (2 ะฟัะพะฑะตะปะฐ) - ะตะดะธะฝััะฒะตะฝะฝัะน ะฑะตะท ัะพะดะธัะตะปั
- ะัะต ะพััะฐะปัะฝัะต ัะทะปั ะะะะะะซ ะธะผะตัั ะพััััะฟ ะะะะฌะจะ 2 ะฟัะพะฑะตะปะพะฒ
- ะัะปะธ ัะทะตะป ะธะผะตะตั ะพััััะฟ 2 ะฟัะพะฑะตะปะฐ ะธ ััะพ ะะ ะบะพัะฝะตะฒะพะน ัะทะตะป โ ะะจะะะะ!
- ะัะธะฑะบะฐ "No parent could be found for X" ะพะทะฝะฐัะฐะตั, ััะพ ัะทะตะป X ะธะผะตะตั ะฝะตะฟัะฐะฒะธะปัะฝัะน ะพััััะฟ

โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
ะะะะะะะ #5: ะะะะะะะะฏ ะฃะะะะ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
- ะะ ะธัะฟะพะปัะทัะน ะบะฐะฒััะบะธ: "ะะฐะทะฒะฐะฝะธะต" โ ะะะะะะะะะฌะะ
- ะะ ะธัะฟะพะปัะทัะน ัะบะพะฑะบะธ (ะบัะพะผะต ะดะฒะพะนะฝัั ะดะปั ะบะพัะฝะตะฒะพะณะพ ัะทะปะฐ)
- ะะพะถะฝะพ: ะฑัะบะฒั, ัะธััั, ะฟัะพะฑะตะปั, ะดะตัะธัั, ะฟะพะดัะตัะบะธะฒะฐะฝะธั
- ะัะต ะฝะฐะทะฒะฐะฝะธั ะฝะฐ ะะฃะกะกะะะ ัะทัะบะต

โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
ะะะะะะะซ ะะะะะะะฌะะะะ ะะะะ (ะะะะะะฃะ ะกะขะะฃะะขะฃะะฃ!)
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ

ะัะธะผะตั 1 (ะฟัะพััะพะน):
mindmap
  root((ะฃะฟัะฐะฒะปะตะฝะธะต ะฟัะพะตะบัะพะผ))
    ะะปะฐะฝะธัะพะฒะฐะฝะธะต
      ะะฐะดะฐัะธ
      ะะตััััั
    ะะตะฐะปะธะทะฐัะธั
      ะะฐะทัะฐะฑะพัะบะฐ
      ะขะตััะธัะพะฒะฐะฝะธะต

ะัะธะผะตั 2 (ัะปะพะถะฝัะน - ะบะฐะบ ะฒ ัะฒะพะตะผ ัะปััะฐะต):
mindmap
  root((ะกะะ ะะ))
    ะะฝะตัะฝะธะต ัะฐะบัะพัั
      ะคะฐะบัะพัั ะฟัะพะธะทะฒะพะดััะฒะฐ
      ะะฝะตัะฝะธะต ะทะฐะธะฝัะตัะตัะพะฒะฐะฝะฝัะต ััะพัะพะฝั
      ะัะฝะพะบ
      ะขัะตะฑะพะฒะฐะฝะธั
      ะะฑัะตััะฒะพ
      ะะฟะฐัะฝัะต ะฟัะพะธะทะฒะพะดััะฒะตะฝะฝัะต ะพะฑัะตะบัั
    ะะฝัััะตะฝะฝะธะต ัะฐะบัะพัั
      ะะพะบัะผะตะฝัะธัะพะฒะฐะฝะฝะฐั ะธะฝัะพัะผะฐัะธั
      ะัะพัะตััะฝะฐั ะผะพะดะตะปั ะกะะ
      ะะพะฝะธัะพัะธะฝะณ, ะธะทะผะตัะตะฝะธั, ะฐะฝะฐะปะธะท ะธ ะพัะตะฝะบะฐ
      ะะตะทัะปััะฐัะธะฒะฝะพััั ััะฝะบัะธะพะฝะธัะพะฒะฐะฝะธั ะฟัะพัะตััะพะฒ ะกะะ
      ะัะพะธะทะฒะพะดััะฒะตะฝะฝัะน ะบะพะฝััะพะปั ะทะฐ ัะพะฑะปัะดะตะฝะธะตะผ ััะตะฑะพะฒะฐะฝะธะน ะฟัะพะผััะปะตะฝะฝะพะน ะฑะตะทะพะฟะฐัะฝะพััะธ
      ะญะบัะฟะตััะธะทะฐ ะฟัะพะผััะปะตะฝะฝะพะน ะฑะตะทะพะฟะฐัะฝะพััะธ
      ะฆะธััะพะฒะธะทะฐัะธั ะฟัะพัะตััะพะฒ ะผะพะฝะธัะพัะธะฝะณะฐ, ะธะทะผะตัะตะฝะธั, ะฐะฝะฐะปะธะทะฐ ะธ ะพัะตะฝะบะธ
      ะะบัะธะฒั ะบะพะผะฟะฐะฝะธะธ
      ะะฝัััะตะฝะฝะธะต ะทะฐะธะฝัะตัะตัะพะฒะฐะฝะฝัะต ััะพัะพะฝั
    ะฆะตะปะธ ะกะะ

โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
ะงะะะะะกะข ะะะะะ ะะขะะะะะะะ - ะะะะะะะฌ ะะะะะซะ ะะฃะะะข! ๐จ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ ะกะขะะะะ 1: "mindmap" ะะะ ะะะะะะะะ?
โ ะกะขะะะะ 2: ะบะพัะฝะตะฒะพะน ัะทะตะป ั ะะะะะ 2 ะะะะะะะะะ?
โ ะขะะะฌะะ ะะะะ ัะทะตะป ั ะพััััะฟะพะผ 2 ะฟัะพะฑะตะปะฐ (ะบะพัะฝะตะฒะพะน)?
โ ะัะต ะพััะฐะปัะฝัะต ัะทะปั ะธะผะตัั ะพััััะฟั 4, 6, 8... (ะบัะฐัะฝัะต 2, ะฝะพ >= 4)?
โ ะะฐะถะดัะน ัะทะตะป (ะบัะพะผะต ะบะพัะฝะตะฒะพะณะพ) ะธะผะตะตั ัะพะดะธัะตะปั?
โ ะะตั ะบะฐะฒััะตะบ ะฒ ะฝะฐะทะฒะฐะฝะธัั ัะทะปะพะฒ?
โ ะัะต ะฝะฐะทะฒะฐะฝะธั ะฝะฐ ััััะบะพะผ ัะทัะบะต?
โ ะะพะด ะผะพะถะฝะพ ัะบะพะฟะธัะพะฒะฐัั ะธ ะฒััะฐะฒะธัั ะฒ Mermaid ัะตะดะฐะบัะพั ะะะ ะะจะะะะ?

โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
ะงะะกะขะซะ ะะจะะะะ ะ ะะะ ะะฅ ะะะะะะะขะฌ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ "There can be only one root" 
   โ ะฃ ัะตะฑั ะฝะตัะบะพะปัะบะพ ัะทะปะพะฒ ั ะพััััะฟะพะผ 2 ะฟัะพะฑะตะปะฐ
   โ ะะะจะะะะ: ะััะฐะฒั ัะพะปัะบะพ ะะะะ ะบะพัะฝะตะฒะพะน ัะทะตะป (2 ะฟัะพะฑะตะปะฐ), ะพััะฐะปัะฝัะต ัะดะตะปะฐะน ะฟะพะดัะตะผะฐะผะธ (4 ะฟัะพะฑะตะปะฐ)

โ "No parent could be found for X"
   โ ะฃะทะตะป X ะธะผะตะตั ะพััััะฟ 2 ะฟัะพะฑะตะปะฐ, ะฝะพ ััะพ ะฝะต ะบะพัะฝะตะฒะพะน ัะทะตะป
   โ ะะะจะะะะ: ะฃะฒะตะปะธัั ะพััััะฟ ัะทะปะฐ X ะดะพ 4+ ะฟัะพะฑะตะปะพะฒ

โ "Syntax error"
   โ ะะตะฟัะฐะฒะธะปัะฝัะน ัะธะฝัะฐะบัะธั, ัะฟะตัะธะฐะปัะฝัะต ัะธะผะฒะพะปั, ะฝะตะฟัะฐะฒะธะปัะฝัะต ะพััััะฟั
   โ ะะะจะะะะ: ะัะพะฒะตัั ะฒัะต ะฟัะฐะฒะธะปะฐ ะฒััะต

โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
ะคะะะะะฌะะะ ะะะะะฃะะะะะะะะะ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
ะะกะะ ะขะซ ะะ ะกะะะะฃะะจะฌ ะญะขะะ ะะะะะะะะ ะขะะงะะ - ะะะ ะะ ะะฃะะะข ะะะะะขะะขะฌ!
ะะะะะะะฌ ะะะ ะะะะะ ะะขะะะะะะะ! ะฃะะะะะกะฌ, ะงะขะ ะะขะกะขะฃะะซ ะะะะะะะฌะะซะ!
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ`;
      }

      const instructions: Record<string, string> = {
        'MindMapMermaid': `ะะะฏ MERMAID MINDMAP (${diagramType}):
- ะะฐัะธะฝะฐะน ั "mindmap"
- ะัะฟะพะปัะทัะน ะพััััะฟั (2 ะฟัะพะฑะตะปะฐ) ะดะปั ัะพะทะดะฐะฝะธั ะธะตัะฐััะธะธ
- ะคะพัะผะฐั: mindmap\\n  root((ะะพัะฝะตะฒะพะน ัะทะตะป))\\n    ะะพะดัะตะผะฐ 1\\n      ะะตัะฐะปั 1.1\\n    ะะพะดัะตะผะฐ 2
- ะะพัะฝะตะฒะพะน ัะทะตะป ะผะพะถะฝะพ ะพะฑะพะทะฝะฐัะธัั ะบะฐะบ root((ะะฐะทะฒะฐะฝะธะต)) ะธะปะธ ะฟัะพััะพ ะบะฐะบ ะฟะตัะฒัะน ัะปะตะผะตะฝั
- ะะฐะถะดัะน ััะพะฒะตะฝั ะธะตัะฐััะธะธ ะดะพะปะถะตะฝ ะธะผะตัั ะฟัะฐะฒะธะปัะฝัะน ะพััััะฟ (2 ะฟัะพะฑะตะปะฐ ะฝะฐ ััะพะฒะตะฝั)
- ะะ ะธัะฟะพะปัะทัะน ัะฟะตัะธะฐะปัะฝัะต ัะธะผะฒะพะปั ะฒ ะฝะฐะทะฒะฐะฝะธัั ัะทะปะพะฒ, ะบะพัะพััะต ะผะพะณัั ัะปะพะผะฐัั ัะธะฝัะฐะบัะธั`,

        'SequenceMermaid': `ะะะฏ MERMAID SEQUENCE (${diagramType}):
- ะะฐัะธะฝะฐะน ั "sequenceDiagram"
- ะัะฟะพะปัะทัะน participant ะดะปั ะพะฟัะตะดะตะปะตะฝะธั ััะฐััะฝะธะบะพะฒ: participant ะะฐะทะฒะฐะฝะธะต
- ะัะฟะพะปัะทัะน ัััะตะปะบะธ ะดะปั ัะพะพะฑัะตะฝะธะน: ะะฐะทะฒะฐะฝะธะต1->>ะะฐะทะฒะฐะฝะธะต2: ะกะพะพะฑัะตะฝะธะต
- ะขะธะฟั ัััะตะปะพะบ: -> (ัะฟะปะพัะฝะฐั), --> (ะฟัะฝะบัะธัะฝะฐั), ->> (ัะฟะปะพัะฝะฐั ั ะฝะฐะบะพะฝะตัะฝะธะบะพะผ), -->> (ะฟัะฝะบัะธัะฝะฐั ั ะฝะฐะบะพะฝะตัะฝะธะบะพะผ)
- ะะพะถะฝะพ ะธัะฟะพะปัะทะพะฒะฐัั ะฐะบัะธะฒะฐัะธั: activate ะะฐะทะฒะฐะฝะธะต ะธ deactivate ะะฐะทะฒะฐะฝะธะต
- ะัะธะผะตั: sequenceDiagram\\n    participant A as ะฃัะฐััะฝะธะบ1\\n    participant B as ะฃัะฐััะฝะธะบ2\\n    A->>B: ะกะพะพะฑัะตะฝะธะต`,

        'ClassMermaid': `ะะะฏ MERMAID CLASS (${diagramType}):
- ะะฐัะธะฝะฐะน ั "classDiagram"
- ะะฟัะตะดะตะปัะน ะบะปะฐััั: class ะะฐะทะฒะฐะฝะธะตะะปะฐััะฐ
- ะะพะฑะฐะฒะปัะน ะฐััะธะฑััั: ะะฐะทะฒะฐะฝะธะตะะปะฐััะฐ : +ะฐััะธะฑัั
- ะะพะฑะฐะฒะปัะน ะผะตัะพะดั: ะะฐะทะฒะฐะฝะธะตะะปะฐััะฐ : +ะผะตัะพะด()
- ะัะฟะพะปัะทัะน ะพัะฝะพัะตะฝะธั: ะะฐะทะฒะฐะฝะธะต1 --> ะะฐะทะฒะฐะฝะธะต2 (ะฐััะพัะธะฐัะธั), ะะฐะทะฒะฐะฝะธะต1 <|-- ะะฐะทะฒะฐะฝะธะต2 (ะฝะฐัะปะตะดะพะฒะฐะฝะธะต)
- ะขะธะฟั ะพัะฝะพัะตะฝะธะน: --> (ะฐััะพัะธะฐัะธั), <|-- (ะฝะฐัะปะตะดะพะฒะฐะฝะธะต), *-- (ะบะพะผะฟะพะทะธัะธั), o-- (ะฐะณัะตะณะฐัะธั)
- ะัะธะผะตั: classDiagram\\n    class ะะปะฐัั1\\n    class ะะปะฐัั2\\n    ะะปะฐัั1 --> ะะปะฐัั2`,

        'StateMermaid': `ะะะฏ MERMAID STATE (${diagramType}):
- ะะฐัะธะฝะฐะน ั "stateDiagram-v2" (ะพะฑัะทะฐัะตะปัะฝะพ v2!)
- ะะฟัะตะดะตะปัะน ัะพััะพัะฝะธั: state ะะฐะทะฒะฐะฝะธะตะกะพััะพัะฝะธั
- ะัะฟะพะปัะทัะน ะฟะตัะตัะพะดั: ะะฐะทะฒะฐะฝะธะต1 --> ะะฐะทะฒะฐะฝะธะต2 : ะกะพะฑััะธะต
- ะะพะถะฝะพ ะธัะฟะพะปัะทะพะฒะฐัั ัะพััะฐะฒะฝัะต ัะพััะพัะฝะธั: state ะกะพััะฐะฒะฝะพะต {\\n    ะกะพััะพัะฝะธะต1\\n    ะกะพััะพัะฝะธะต2\\n}
- ะัะธะผะตั: stateDiagram-v2\\n    [*] --> ะกะพััะพัะฝะธะต1\\n    ะกะพััะพัะฝะธะต1 --> ะกะพััะพัะฝะธะต2 : ะกะพะฑััะธะต`,

        'ActivityMermaid': `ะะะฏ MERMAID ACTIVITY (${diagramType}):
- ะะฐัะธะฝะฐะน ั "flowchart TD" (ัะฒะตััั ะฒะฝะธะท) ะธะปะธ "flowchart LR" (ัะปะตะฒะฐ ะฝะฐะฟัะฐะฒะพ)
- ะัะฟะพะปัะทัะน ัะทะปั: ะะฐะทะฒะฐะฝะธะต[ะขะตะบัั] (ะฟััะผะพัะณะพะปัะฝะธะบ), ะะฐะทะฒะฐะฝะธะต{ะฃัะปะพะฒะธะต} (ัะพะผะฑ), ะะฐะทะฒะฐะฝะธะต((ะััะณ))
- ะัะฟะพะปัะทัะน ัััะตะปะบะธ: ะะฐะทะฒะฐะฝะธะต1 --> ะะฐะทะฒะฐะฝะธะต2
- ะคะพัะผะฐัั ัะทะปะพะฒ: [ะขะตะบัั] (ะฟััะผะพัะณะพะปัะฝะธะบ), {ะฃัะปะพะฒะธะต} (ัะพะผะฑ), ((ะััะณ)), (ะกะบััะณะปะตะฝะฝัะน)
- ะัะธะผะตั: flowchart TD\\n    A[ะะฐัะฐะปะพ] --> B{ะฃัะปะพะฒะธะต?}\\n    B -->|ะะฐ| C[ะะตะนััะฒะธะต1]\\n    B -->|ะะตั| D[ะะตะนััะฒะธะต2]`,

        'GanttMermaid': `ะะะฏ MERMAID GANTT (${diagramType}):
- ะะฐัะธะฝะฐะน ั "gantt"
- ะะพะฑะฐะฒะปัะน ะทะฐะณะพะปะพะฒะพะบ: title ะะฐะทะฒะฐะฝะธะต ะฟัะพะตะบัะฐ
- ะะฟัะตะดะตะปัะน ัะพัะผะฐั ะดะฐัั: dateFormat YYYY-MM-DD
- ะะพะฑะฐะฒะปัะน ัะตะบัะธะธ: section ะะฐะทะฒะฐะฝะธะต ัะตะบัะธะธ
- ะะพะฑะฐะฒะปัะน ะทะฐะดะฐัะธ: ะะฐะทะฒะฐะฝะธะต ะทะฐะดะฐัะธ :done, ะะฐะทะฒะฐะฝะธะต, ะะฐัะฐ ะฝะฐัะฐะปะฐ, ะะปะธัะตะปัะฝะพััั
- ะกัะฐัััั: :done (ะฒัะฟะพะปะฝะตะฝะพ), :active (ะฐะบัะธะฒะฝะพ), :crit (ะบัะธัะธัะฝะพ), :milestone (ะฒะตัะฐ)
- ะัะธะผะตั: gantt\\n    title ะัะพะตะบั\\n    dateFormat YYYY-MM-DD\\n    section ะกะตะบัะธั1\\n    ะะฐะดะฐัะฐ1 :done, 2024-01-01, 5d`,

        'ERMermaid': `ะะะฏ MERMAID ER (${diagramType}):
- ะะฐัะธะฝะฐะน ั "erDiagram"
- ะะฟัะตะดะตะปัะน ัััะฝะพััะธ: ะะฐะทะฒะฐะฝะธะตะกััะฝะพััะธ {\\n    ัะธะฟ ะฟะพะปะต\\n    ัะธะฟ ะฟะพะปะต2\\n}
- ะัะฟะพะปัะทัะน ะพัะฝะพัะตะฝะธั: ะกััะฝะพััั1 ||--|| ะกััะฝะพััั2 (ะพะดะธะฝ ะบ ะพะดะฝะพะผั), ะกััะฝะพััั1 }o--|| ะกััะฝะพััั2 (ะผะฝะพะณะธะต ะบ ะพะดะฝะพะผั)
- ะขะธะฟั ะพัะฝะพัะตะฝะธะน: ||--|| (ะพะดะธะฝ ะบ ะพะดะฝะพะผั), }o--|| (ะผะฝะพะณะธะต ะบ ะพะดะฝะพะผั), ||--o{ (ะพะดะธะฝ ะบะพ ะผะฝะพะณะธะผ), }o--o{ (ะผะฝะพะณะธะต ะบะพ ะผะฝะพะณะธะผ)
- ะัะธะผะตั: erDiagram\\n    ะกะฃะฉะะะกะขะฌ1 {\\n        int id\\n        string ะฝะฐะทะฒะฐะฝะธะต\\n    }\\n    ะกะฃะฉะะะกะขะฌ1 ||--|| ะกะฃะฉะะะกะขะฌ2`,

        'Architecture': `ะะะฏ ARCHITECTURE (${diagramType}):
- ะะฐัะธะฝะฐะน ั "graph TD" (ัะฒะตััั ะฒะฝะธะท) ะธะปะธ "graph LR" (ัะปะตะฒะฐ ะฝะฐะฟัะฐะฒะพ)
- ะัะฟะพะปัะทัะน ัะทะปั ะดะปั ะบะพะผะฟะพะฝะตะฝัะพะฒ: ะะฐะทะฒะฐะฝะธะต[ะะพะผะฟะพะฝะตะฝั]
- ะัะฟะพะปัะทัะน ัััะตะปะบะธ ะดะปั ัะฒัะทะตะน: ะะฐะทะฒะฐะฝะธะต1 --> ะะฐะทะฒะฐะฝะธะต2
- ะะพะถะฝะพ ะธัะฟะพะปัะทะพะฒะฐัั ะฟะพะดะณัะฐัั: subgraph ะะฐะทะฒะฐะฝะธะต\\n    ะฃะทะตะป1\\n    ะฃะทะตะป2\\n    end
- ะคะพัะผะฐัั ัะทะปะพะฒ: [ะขะตะบัั] (ะฟััะผะพัะณะพะปัะฝะธะบ), {ะขะตะบัั} (ัะพะผะฑ), ((ะขะตะบัั)) (ะบััะณ)
- ะัะธะผะตั: graph TD\\n    A[ะะพะผะฟะพะฝะตะฝั1] --> B[ะะพะผะฟะพะฝะตะฝั2]\\n    B --> C[ะะพะผะฟะพะฝะตะฝั3]`,

        'C4': `ะะะฏ C4 (${diagramType}):
- ะะฐัะธะฝะฐะน ั "C4Context" ะดะปั ะบะพะฝัะตะบััะฝะพะน ะดะธะฐะณัะฐะผะผั
- ะัะฟะพะปัะทัะน Person ะดะปั ะปัะดะตะน: Person(alias, "ะะฐะทะฒะฐะฝะธะต", "ะะฟะธัะฐะฝะธะต")
- ะัะฟะพะปัะทัะน System ะดะปั ัะธััะตะผ: System(alias, "ะะฐะทะฒะฐะฝะธะต", "ะะฟะธัะฐะฝะธะต")
- ะัะฟะพะปัะทัะน SystemDb ะดะปั ะฑะฐะท ะดะฐะฝะฝัั: SystemDb(alias, "ะะฐะทะฒะฐะฝะธะต", "ะะฟะธัะฐะฝะธะต")
- ะัะฟะพะปัะทัะน Rel ะดะปั ัะฒัะทะตะน: Rel(ะพัะบัะดะฐ, ะบัะดะฐ, "ะกะฒัะทั", "ะขะตัะฝะพะปะพะณะธั")
- ะัะต ะฟะฐัะฐะผะตััั ะฒ ะบะฐะฒััะบะฐั ะดะพะปะถะฝั ะฑััั ะฝะฐ ััััะบะพะผ
- ะัะธะผะตั: C4Context\\n    Person(user, "ะะพะปัะทะพะฒะฐัะตะปั", "ะัะฟะพะปัะทัะตั ัะธััะตะผั")\\n    System(system, "ะะตะฑ-ัะธััะตะผะฐ", "ะัะฝะพะฒะฝะฐั ัะธััะตะผะฐ")\\n    Rel(user, system, "ะัะฟะพะปัะทัะตั", "HTTPS")`,

        'Git': `ะะะฏ GIT (${diagramType}):
- ะะฐัะธะฝะฐะน ั "gitGraph"
- ะัะฟะพะปัะทัะน commit ะดะปั ะบะพะผะผะธัะพะฒ: commit id: "ะะฐะทะฒะฐะฝะธะต ะบะพะผะผะธัะฐ"
- ะัะฟะพะปัะทัะน branch ะดะปั ะฒะตัะพะบ: branch ะฝะฐะทะฒะฐะฝะธะต_ะฒะตัะบะธ
- ะัะฟะพะปัะทัะน checkout ะดะปั ะฟะตัะตะบะปััะตะฝะธั: checkout ะฝะฐะทะฒะฐะฝะธะต_ะฒะตัะบะธ
- ะัะฟะพะปัะทัะน merge ะดะปั ัะปะธัะฝะธั: merge ะฝะฐะทะฒะฐะฝะธะต_ะฒะตัะบะธ
- ะะฐะทะฒะฐะฝะธั ะบะพะผะผะธัะพะฒ ะฒ ะบะฐะฒััะบะฐั ะดะพะปะถะฝั ะฑััั ะฝะฐ ััััะบะพะผ
- ะัะธะผะตั: gitGraph\\n    commit id: "ะะตัะฒัะน ะบะพะผะผะธั"\\n    branch develop\\n    checkout develop\\n    commit id: "ะะพะผะผะธั ะฒ develop"\\n    checkout main\\n    merge develop`,

        'Kanban': `ะะะฏ KANBAN (${diagramType}):
- ะะฐัะธะฝะฐะน ั "kanban"
- ะะฟัะตะดะตะปัะน ะบะพะปะพะฝะบะธ: section ะะฐะทะฒะฐะฝะธะต ะบะพะปะพะฝะบะธ
- ะะพะฑะฐะฒะปัะน ะทะฐะดะฐัะธ ะฒ ะบะพะปะพะฝะบะธ: ะะฐะทะฒะฐะฝะธะต ะทะฐะดะฐัะธ
- ะะพะถะฝะพ ะธัะฟะพะปัะทะพะฒะฐัั ััะฐัััั: ะะฐะทะฒะฐะฝะธะต ะทะฐะดะฐัะธ :done (ะฒัะฟะพะปะฝะตะฝะพ), :active (ะฐะบัะธะฒะฝะพ), :crit (ะบัะธัะธัะฝะพ)
- ะะฐะทะฒะฐะฝะธั ะบะพะปะพะฝะพะบ ะธ ะทะฐะดะฐั ะดะพะปะถะฝั ะฑััั ะฝะฐ ััััะบะพะผ
- ะัะธะผะตั: kanban\\n    section ะกะดะตะปะฐัั\\n    ะะฐะดะฐัะฐ 1\\n    ะะฐะดะฐัะฐ 2 :active\\n    section ะ ัะฐะฑะพัะต\\n    ะะฐะดะฐัะฐ 3\\n    section ะะพัะพะฒะพ\\n    ะะฐะดะฐัะฐ 4 :done`,

        'Pie': `ะะะฏ PIE (${diagramType}):
- ะะฐัะธะฝะฐะน ั "pie"
- ะะพะฑะฐะฒะปัะน ะทะฐะณะพะปะพะฒะพะบ: title "ะะฐะทะฒะฐะฝะธะต ะดะธะฐะณัะฐะผะผั" (ะทะฐะณะพะปะพะฒะพะบ ะฒ ะบะฐะฒััะบะฐั)
- ะะฟัะตะดะตะปัะน ะดะพะปะธ: "ะะฐะทะฒะฐะฝะธะต" : ะทะฝะฐัะตะฝะธะต
- ะะฝะฐัะตะฝะธั ะดะพะปะถะฝั ะฑััั ัะธัะปะฐะผะธ (ะฑะตะท ะบะฐะฒััะตะบ)
- ะะฐะทะฒะฐะฝะธั ัะปะตะผะตะฝัะพะฒ ะฒ ะบะฐะฒััะบะฐั ะดะพะปะถะฝั ะฑััั ะฝะฐ ััััะบะพะผ
- ะัะธะผะตั: pie title "ะะฐัะฟัะตะดะตะปะตะฝะธะต"\\n    "ะญะปะตะผะตะฝั1" : 30\\n    "ะญะปะตะผะตะฝั2" : 50\\n    "ะญะปะตะผะตะฝั3" : 20`,

        'Quadrant': `ะะะฏ QUADRANT (${diagramType}):
- ะะฐัะธะฝะฐะน ั "quadrantChart"
- ะะฟัะตะดะตะปัะน ะพัะธ: x-axis ะะฐะทะฒะฐะฝะธะต1 --> ะะฐะทะฒะฐะฝะธะต2
- ะะฟัะตะดะตะปัะน ะบะฒะฐะดัะฐะฝัั: quadrant ะะฐะทะฒะฐะฝะธะต ะบะฒะฐะดัะฐะฝัะฐ
- ะะพะฑะฐะฒะปัะน ัะพัะบะธ: ะะฐะทะฒะฐะฝะธะต ัะพัะบะธ: [x, y]
- ะัะธะผะตั: quadrantChart\\n    x-axis ะะธะทะบะธะน --> ะััะพะบะธะน\\n    y-axis ะะธะทะบะธะน --> ะััะพะบะธะน\\n    quadrant Q1\\n    ะขะพัะบะฐ1: [0.5, 0.5]`,

        'Radar': `ะะะฏ RADAR (${diagramType}):
- ะะฐัะธะฝะฐะน ั "radar"
- ะะฟัะตะดะตะปัะน ะพัะธ: x-axis ะะฐะทะฒะฐะฝะธะต ะพัะธ
- ะะพะฑะฐะฒะปัะน ัะตัะธะธ ะดะฐะฝะฝัั: ะะฐะทะฒะฐะฝะธะต ัะตัะธะธ --> ะทะฝะฐัะตะฝะธะต1, ะทะฝะฐัะตะฝะธะต2, ะทะฝะฐัะตะฝะธะต3
- ะะพะปะธัะตััะฒะพ ะทะฝะฐัะตะฝะธะน ะดะพะปะถะฝะพ ัะพะพัะฒะตัััะฒะพะฒะฐัั ะบะพะปะธัะตััะฒั ะพัะตะน
- ะัะธะผะตั: radar\\n    x-axis ะัั1, ะัั2, ะัั3\\n    ะกะตัะธั1 --> 5, 3, 4\\n    ะกะตัะธั2 --> 2, 4, 3`,

        'Timeline': `ะะะฏ TIMELINE (${diagramType}):
- ะะฐัะธะฝะฐะน ั "timeline"
- ะะฟัะตะดะตะปัะน ัะพะฑััะธั: title ะะฐะทะฒะฐะฝะธะต ัะพะฑััะธั
- ะะพะถะฝะพ ะณััะฟะฟะธัะพะฒะฐัั ะฟะพ ะฟะตัะธะพะดะฐะผ: section ะะตัะธะพะด\\n    ะกะพะฑััะธะต1 : ะกะพะฑััะธะต2
- ะัะธะผะตั: timeline\\n    title ะััะพัะธั\\n    section ะะตัะธะพะด1\\n    ะกะพะฑััะธะต1 : ะกะพะฑััะธะต2\\n    section ะะตัะธะพะด2\\n    ะกะพะฑััะธะต3`,

        'UserJourney': `ะะะฏ USER JOURNEY (${diagramType}):
- ะะฐัะธะฝะฐะน ั "journey"
- ะะฟัะตะดะตะปัะน ััะฐะฟั: title ะะฐะทะฒะฐะฝะธะต ััะฐะฟะฐ : ะพัะตะฝะบะฐ
- ะัะตะฝะบะธ: 0-5 (0 - ะพัะตะฝั ะฟะปะพัะพ, 5 - ะพัะปะธัะฝะพ)
- ะะพะถะฝะพ ะธัะฟะพะปัะทะพะฒะฐัั ะฝะตัะบะพะปัะบะพ ััะฐะฟะพะฒ ะฟะพะดััะด
- ะัะธะผะตั: journey\\n    title ะะพะปัะทะพะฒะฐัะตะปััะบะธะน ะฟััั\\n    ะญัะฐะฟ1 : 5\\n    ะญัะฐะฟ2 : 3\\n    ะญัะฐะฟ3 : 4`,

        'XY': `ะะะฏ XY (${diagramType}):
- ะะฐัะธะฝะฐะน ั "xychart-beta"
- ะะฟัะตะดะตะปัะน ะพัะธ: x-axis [ะทะฝะฐัะตะฝะธะต1, ะทะฝะฐัะตะฝะธะต2, ...] ะธะปะธ x-axis [min..max]
- ะะฟัะตะดะตะปัะน ัะตัะธะธ: line [ะทะฝะฐัะตะฝะธะต1, ะทะฝะฐัะตะฝะธะต2, ...] ะธะปะธ bar [ะทะฝะฐัะตะฝะธะต1, ะทะฝะฐัะตะฝะธะต2, ...]
- ะะพะปะธัะตััะฒะพ ะทะฝะฐัะตะฝะธะน ะฒ ัะตัะธะธ ะดะพะปะถะฝะพ ัะพะพัะฒะตัััะฒะพะฒะฐัั ะบะพะปะธัะตััะฒั ัะพัะตะบ ะฝะฐ ะพัะธ X
- ะัะธะผะตั: xychart-beta\\n    x-axis [1, 2, 3, 4, 5]\\n    y-axis [0, 100]\\n    line [10, 20, 30, 40, 50]`
      };

      return instructions[type] || '';
    };

    const mermaidDiagramType = isMermaid ? getMermaidDiagramType(diagramType) : '';

    // ะคะพัะผะธััะตะผ ะฟัะพะผะฟั ะดะปั ะณะตะฝะตัะฐัะธะธ ะบะพะดะฐ
    const systemPrompt = isMermaid 
      ? `ะขั ัะบัะฟะตัั ะฟะพ ัะพะทะดะฐะฝะธั ะดะธะฐะณัะฐะผะผ ะฒ ัะพัะผะฐัะต Mermaid. ะขะฒะพั ะทะฐะดะฐัะฐ - ัะพะทะดะฐัั ะะะะะะะขะะซะ ะธ ะะะะะะะซะ ะบะพะด Mermaid ะดะปั ${mermaidDiagramType} ะดะธะฐะณัะฐะผะผั, ะบะพัะพััะน ะะะ ะะจะะะะ ะพััะตะฝะดะตัะธััั ะฒ Mermaid.

ะะะะขะะงะะกะะ ะะะะะ:
1. ะะตะฝะตัะธััะน ะขะะะฌะะ ะฒะฐะปะธะดะฝัะน ะบะพะด Mermaid, ะบะพัะพััะน ะผะพะถะตั ะฑััั ััะฟะตัะฝะพ ะพััะตะฝะดะตัะตะฝ
2. ะะพะด ะะะะะะ ะฝะฐัะธะฝะฐัััั ั ะฟัะฐะฒะธะปัะฝะพะณะพ ัะธะฟะฐ ะดะธะฐะณัะฐะผะผั (${mermaidDiagramType}) - ััะพ ะะะฏะะะขะะะฌะะ
3. ะัะฟะพะปัะทัะน ะกะขะะะะ ะฟัะฐะฒะธะปัะฝัะน ัะธะฝัะฐะบัะธั Mermaid ะดะปั ัะบะฐะทะฐะฝะฝะพะณะพ ัะธะฟะฐ ะดะธะฐะณัะฐะผะผั ัะพะณะปะฐัะฝะพ ะพัะธัะธะฐะปัะฝะพะน ะดะพะบัะผะตะฝัะฐัะธะธ
4. ะะกะ ะะะะะะะะฏ ะฃะะะะ, ะะะะกะกะะ, ะกะะกะขะะฏะะะ ะ ะะะฃะะะฅ ะญะะะะะะขะะ ะะะะะะซ ะะซะขะฌ ะะ ะะฃะกะกะะะ ะฏะะซะะ
5. ะัะฟะพะปัะทัะน ััััะบะธะต ะฝะฐะทะฒะฐะฝะธั ะดะปั ะฒัะตั ัะปะตะผะตะฝัะพะฒ (ะฝะฐะฟัะธะผะตั: "ะะฝััะธััั", "ะกััะดะตะฝั", "ะัะตะฟะพะดะฐะฒะฐัะตะปั")
6. ะกะธะฝัะฐะบัะธั Mermaid ะพััะฐะตััั ะฝะฐ ะฐะฝะณะปะธะนัะบะพะผ (classDiagram, sequenceDiagram, etc.), ะฝะพ ัะพะดะตัะถะธะผะพะต - ะฝะฐ ััััะบะพะผ
7. ะะะะะะะฌ ะบะพะด ะฟะตัะตะด ะพัะฟัะฐะฒะบะพะน: ะฒัะต ัะบะพะฑะบะธ ะทะฐะบัััั, ะฟัะฐะฒะธะปัะฝัะต ัะฐะทะดะตะปะธัะตะปะธ, ะฟัะฐะฒะธะปัะฝะพะต ะบะพะปะธัะตััะฒะพ ัะปะตะผะตะฝัะพะฒ
8. ะะ ะธัะฟะพะปัะทัะน ัะฟะตัะธะฐะปัะฝัะต ัะธะผะฒะพะปั ะฒ ะฝะฐะทะฒะฐะฝะธัั, ะบะพัะพััะต ะผะพะณัั ัะปะพะผะฐัั ัะธะฝัะฐะบัะธั (ะบะฐะฒััะบะธ ะฒะฝัััะธ ะฝะฐะทะฒะฐะฝะธะน ัะทะปะพะฒ, ะฝะตะทะฐะบััััะต ัะบะพะฑะบะธ)
9. ะะพัะปะต ะบะพะดะฐ ะดะธะฐะณัะฐะผะผั, ะดะพะฑะฐะฒั ะณะปะพััะฐัะธะน ะฒ ัะพัะผะฐัะต JSON ะผะฐััะธะฒะฐ ะพะฑัะตะบัะพะฒ ั ะฟะพะปัะผะธ "element" ะธ "description"
10. ะัะปะธ ัะพะผะฝะตะฒะฐะตัััั ะฒ ัะธะฝัะฐะบัะธัะต - ะธัะฟะพะปัะทัะน ะฟัะพัััะต ะบะพะฝััััะบัะธะธ, ะบะพัะพััะต ัะพัะฝะพ ัะฐะฑะพัะฐัั`
      : `ะขั ัะบัะฟะตัั ะฟะพ ัะพะทะดะฐะฝะธั ะดะธะฐะณัะฐะผะผ ะฒ ัะพัะผะฐัะต PlantUML. ะขะฒะพั ะทะฐะดะฐัะฐ - ัะพะทะดะฐัั ะบะพััะตะบัะฝัะน ะบะพะด PlantUML ะดะปั ัะบะฐะทะฐะฝะฝะพะณะพ ัะธะฟะฐ ะดะธะฐะณัะฐะผะผั.

ะะะะขะะงะะกะะ ะะะะะ:
1. ะะตะฝะตัะธััะน ัะพะปัะบะพ ะฒะฐะปะธะดะฝัะน ะบะพะด PlantUML, ะฑะตะท ะดะพะฟะพะปะฝะธัะตะปัะฝัั ะพะฑัััะฝะตะฝะธะน
2. ะะพะด ะดะพะปะถะตะฝ ะฝะฐัะธะฝะฐัััั ั @startuml ะธ ะทะฐะบะฐะฝัะธะฒะฐัััั @enduml
3. ะัะฟะพะปัะทัะน ะฟัะฐะฒะธะปัะฝัะน ัะธะฝัะฐะบัะธั ะดะปั ัะบะฐะทะฐะฝะฝะพะณะพ ัะธะฟะฐ ะดะธะฐะณัะฐะผะผั (ะฐะฝะณะปะธะนัะบะธะต ะบะปััะตะฒัะต ัะปะพะฒะฐ: class, interface, component, etc.)
4. ะะกะ ะะะะะะะะฏ ะะะชะะะขะะ, ะะะะกะกะะ, ะะะขะะะะ, ะะขะะะะฃะขะะ ะ ะะะฃะะะฅ ะญะะะะะะขะะ ะะะะะะซ ะะซะขะฌ ะะ ะะฃะกะกะะะ ะฏะะซะะ
5. ะัะฟะพะปัะทัะน ััััะบะธะต ะฝะฐะทะฒะฐะฝะธั ะดะปั ะฒัะตั ัััะฝะพััะตะน ะฒ ะดะธะฐะณัะฐะผะผะต (ะฝะฐะฟัะธะผะตั: "ะะฝััะธััั" ะฒะผะตััะพ "Institute", "ะกััะดะตะฝั" ะฒะผะตััะพ "Student")
6. ะกะธะฝัะฐะบัะธั PlantUML ะพััะฐะตััั ะฝะฐ ะฐะฝะณะปะธะนัะบะพะผ (class, interface, ->, etc.), ะฝะพ ัะพะดะตัะถะธะผะพะต - ะฝะฐ ััััะบะพะผ
7. ะะพัะปะต ะบะพะดะฐ ะดะธะฐะณัะฐะผะผั, ะดะพะฑะฐะฒั ะณะปะพััะฐัะธะน ะฒ ัะพัะผะฐัะต JSON ะผะฐััะธะฒะฐ ะพะฑัะตะบัะพะฒ ั ะฟะพะปัะผะธ "element" ะธ "description"`;

    const diagramTypeDescriptions: Record<string, string> = {
      'UseCase': 'UML ะดะธะฐะณัะฐะผะผะฐ ะฟัะตัะตะดะตะฝัะพะฒ (Use Case Diagram)',
      'Object': 'UML ะดะธะฐะณัะฐะผะผะฐ ะพะฑัะตะบัะพะฒ (Object Diagram)',
      'SequenceMermaid': 'Sequence ะดะธะฐะณัะฐะผะผะฐ (Mermaid)',
      'ClassMermaid': 'Class ะดะธะฐะณัะฐะผะผะฐ (Mermaid)',
      'StateMermaid': 'State ะดะธะฐะณัะฐะผะผะฐ (Mermaid)',
      'ActivityMermaid': 'Activity ะดะธะฐะณัะฐะผะผะฐ (Mermaid)',
      'GanttMermaid': 'Gantt ะดะธะฐะณัะฐะผะผะฐ (Mermaid)',
      'ERMermaid': 'ER ะดะธะฐะณัะฐะผะผะฐ (Mermaid)',
      'MindMapMermaid': 'MindMap ะดะธะฐะณัะฐะผะผะฐ (Mermaid)',
      'MindMapMax': 'MindMap ะดะธะฐะณัะฐะผะผะฐ (Mermaid) - ะะฐะบัะธะผะฐะปัะฝะพ ะบะฐัะตััะฒะตะฝะฝะฐั ะฒะตััะธั',
      'Sequence': 'UML ะดะธะฐะณัะฐะผะผะฐ ะฟะพัะปะตะดะพะฒะฐัะตะปัะฝะพััะธ (Sequence Diagram)',
      'Class': 'UML ะดะธะฐะณัะฐะผะผะฐ ะบะปะฐััะพะฒ (Class Diagram)',
      'State': 'UML ะดะธะฐะณัะฐะผะผะฐ ัะพััะพัะฝะธะน (State Diagram)',
      'Activity': 'UML ะดะธะฐะณัะฐะผะผะฐ ะฐะบัะธะฒะฝะพััะธ (Activity Diagram)',
      'Gantt': 'ะะธะฐะณัะฐะผะผะฐ ะะฐะฝัะฐ (Gantt Chart)',
      'ER': 'ER ะดะธะฐะณัะฐะผะผะฐ (Entity-Relationship Diagram)',
      'MindMap': 'ะะฝัะตะปะปะตะบั-ะบะฐััะฐ (Mind Map)',
      'Architecture': 'Architecture ะดะธะฐะณัะฐะผะผะฐ (Mermaid)',
      'C4': 'C4 ะดะธะฐะณัะฐะผะผะฐ (Mermaid)',
      'Git': 'Git ะดะธะฐะณัะฐะผะผะฐ (Mermaid)',
      'Kanban': 'Kanban ะดะธะฐะณัะฐะผะผะฐ (Mermaid)',
      'Pie': 'Pie ะดะธะฐะณัะฐะผะผะฐ (Mermaid)',
      'Quadrant': 'Quadrant ะดะธะฐะณัะฐะผะผะฐ (Mermaid)',
      'Radar': 'Radar ะดะธะฐะณัะฐะผะผะฐ (Mermaid)',
      'Timeline': 'Timeline ะดะธะฐะณัะฐะผะผะฐ (Mermaid)',
      'UserJourney': 'User Journey ะดะธะฐะณัะฐะผะผะฐ (Mermaid)',
      'XY': 'XY ะดะธะฐะณัะฐะผะผะฐ (Mermaid)',
    };

    const typeDescription = diagramTypeDescriptions[diagramType] || diagramType;

    let userPrompt = '';
    
    if (isMermaid) {
      // ะะพะปััะฐะตะผ ะดะตัะฐะปัะฝัะต ะธะฝััััะบัะธะธ ะฟะพ ัะธะฝัะฐะบัะธัั ะดะปั ะดะฐะฝะฝะพะณะพ ัะธะฟะฐ ะดะธะฐะณัะฐะผะผั
      const syntaxInstructions = getMermaidSyntaxInstructions(diagramType, mermaidDiagramType);
      
      userPrompt = `ะกะพะทะดะฐะน ${typeDescription} ะดะปั ัะปะตะดัััะตะณะพ ะพะฑัะตะบัะฐ/ะฟัะพัะตััะฐ:

${objectDescription}

ะะะะขะะงะะกะะ ะะะะะ:
1. ะัะต ะฝะฐะทะฒะฐะฝะธั ัะทะปะพะฒ, ะบะปะฐััะพะฒ, ัะพััะพัะฝะธะน ะธ ะดััะณะธั ัะปะตะผะตะฝัะพะฒ ะดะพะปะถะฝั ะฑััั ะฝะฐ ััััะบะพะผ ัะทัะบะต
2. ะัะฟะพะปัะทัะน ััััะบะธะต ะฝะฐะทะฒะฐะฝะธั ะดะปั ะฒัะตั ัะปะตะผะตะฝัะพะฒ (ะฝะฐะฟัะธะผะตั: "ะะฝััะธััั", "ะกััะดะตะฝั", "ะัะตะฟะพะดะฐะฒะฐัะตะปั", "ะััั" ะธ ั.ะด.)
3. ะกะธะฝัะฐะบัะธั Mermaid ะพััะฐะตััั ะฝะฐ ะฐะฝะณะปะธะนัะบะพะผ (${mermaidDiagramType}, classDiagram, sequenceDiagram, etc.), ะฝะพ ัะพะดะตัะถะธะผะพะต - ะฝะฐ ััััะบะพะผ
4. ะกะขะะะะ ัะปะตะดัะน ัะธะฝัะฐะบัะธัั Mermaid ะดะปั ัะธะฟะฐ ${mermaidDiagramType}
5. ะัะพะฒะตัั, ััะพ ะบะพะด ะฒะฐะปะธะดะฝัะน ะธ ะผะพะถะตั ะฑััั ะพััะตะฝะดะตัะตะฝ ะฑะตะท ะพัะธะฑะพะบ
6. ะะ ะธัะฟะพะปัะทัะน ัะฟะตัะธะฐะปัะฝัะต ัะธะผะฒะพะปั ะฒ ะฝะฐะทะฒะฐะฝะธัั, ะบะพัะพััะต ะผะพะณัั ัะปะพะผะฐัั ัะธะฝัะฐะบัะธั (ะฝะฐะฟัะธะผะตั: ะบะฐะฒััะบะธ, ัะบะพะฑะบะธ ะฒ ะฝะตะฟัะฐะฒะธะปัะฝัั ะผะตััะฐั)
7. ะัะฟะพะปัะทัะน ะฟัะฐะฒะธะปัะฝัะต ะพััััะฟั ะธ ัะพัะผะฐัะธัะพะฒะฐะฝะธะต

${syntaxInstructions}

ะะะะะะะซ ะะะะะะะฌะะะะ ะกะะะขะะะกะะกะ:
- ะัะตะณะดะฐ ะฝะฐัะธะฝะฐะน ั ะฟัะฐะฒะธะปัะฝะพะณะพ ะบะปััะตะฒะพะณะพ ัะปะพะฒะฐ ัะธะฟะฐ ะดะธะฐะณัะฐะผะผั
- ะัะฟะพะปัะทัะน ะฟัะฐะฒะธะปัะฝัะต ัะฐะทะดะตะปะธัะตะปะธ ะธ ัะธะฝัะฐะบัะธัะตัะบะธะต ะบะพะฝััััะบัะธะธ
- ะัะพะฒะตัั ัะพะพัะฒะตัััะฒะธะต ะบะพะปะธัะตััะฒะฐ ัะปะตะผะตะฝัะพะฒ (ะฝะฐะฟัะธะผะตั, ะฒ Radar ะบะพะปะธัะตััะฒะพ ะทะฝะฐัะตะฝะธะน ะดะพะปะถะฝะพ ัะพะพัะฒะตัััะฒะพะฒะฐัั ะบะพะปะธัะตััะฒั ะพัะตะน)
- ะฃะฑะตะดะธัั, ััะพ ะฒัะต ัะบะพะฑะบะธ, ะบะฐะฒััะบะธ ะธ ะดััะณะธะต ัะธะผะฒะพะปั ะฟัะฐะฒะธะปัะฝะพ ะทะฐะบัััั`;

      if (context) {
        userPrompt += `\n\nะะพะฟะพะปะฝะธัะตะปัะฝัะน ะบะพะฝัะตะบัั ะธะท ะดะพะบัะผะตะฝัะพะฒ:\n${context.substring(0, 3000)}`;
      }

      userPrompt += `\n\nะกะณะตะฝะตัะธััะน ะบะพะด Mermaid ะธ ะณะปะพััะฐัะธะน. ะคะพัะผะฐั ะพัะฒะตัะฐ:
\`\`\`mermaid
${mermaidDiagramType}
[ะบะพะด ะดะธะฐะณัะฐะผะผั ั ััััะบะธะผะธ ะฝะฐะทะฒะฐะฝะธัะผะธ ัะปะตะผะตะฝัะพะฒ - ะะะฏะะะขะะะฌะะ ะฒะฐะปะธะดะฝัะน ัะธะฝัะฐะบัะธั Mermaid]
\`\`\`

${diagramType === 'MindMapMax' ? `๐จ๐จ๐จ ะะะะขะะงะะกะะ ะะะะะ ะะะฏ MINDMAP MAX! ๐จ๐จ๐จ

ะะะะะ ะะขะะะะะะะ ะะะะ ะะะฏะะะขะะะฌะะ ะะะะะะะฌ:

1. โ ะะะะะะฏ ะกะขะะะะ: ัะพัะฝะพ "mindmap" ะะะ ะะะะะะะะ?
2. โ ะะขะะะะฏ ะกะขะะะะ: ะบะพัะฝะตะฒะพะน ัะทะตะป ั ะะะะะ 2 ะะะะะะะะะ ะพััััะฟะฐ?
3. โ ะขะะะฌะะ ะะะะ ัะทะตะป ั ะพััััะฟะพะผ 2 ะฟัะพะฑะตะปะฐ (ะบะพัะฝะตะฒะพะน)?
4. โ ะัะต ะพััะฐะปัะฝัะต ัะทะปั ะธะผะตัั ะพััััะฟั 4, 6, 8... (>= 4, ะบัะฐัะฝัะต 2)?
5. โ ะะตั ัะทะปะพะฒ ั ะพััััะฟะพะผ 2 ะฟัะพะฑะตะปะฐ, ะบัะพะผะต ะบะพัะฝะตะฒะพะณะพ?
6. โ ะะฐะถะดัะน ัะทะตะป (ะบัะพะผะต ะบะพัะฝะตะฒะพะณะพ) ะธะผะตะตั ัะพะดะธัะตะปั?
7. โ ะะตั ะบะฐะฒััะตะบ ะฒ ะฝะฐะทะฒะฐะฝะธัั ัะทะปะพะฒ?
8. โ ะัะต ะฝะฐะทะฒะฐะฝะธั ะฝะฐ ััััะบะพะผ ัะทัะบะต?

ะะกะะ ะฅะะขะฌ ะะะะ ะะฃะะะข ะะ ะะซะะะะะะ - ะะกะะะะะฌ ะะะ ะะะะะ ะะขะะะะะะะ!

ะะะะะะ ะะะะะะะฌะะะะ ะะะะ:
mindmap
  root((ะกะะ ะะ))
    ะะฝะตัะฝะธะต ัะฐะบัะพัั
      ะคะฐะบัะพัั ะฟัะพะธะทะฒะพะดััะฒะฐ
      ะัะฝะพะบ
    ะะฝัััะตะฝะฝะธะต ัะฐะบัะพัั
      ะะพะบัะผะตะฝัะธัะพะฒะฐะฝะฝะฐั ะธะฝัะพัะผะฐัะธั
      ะัะพัะตััะฝะฐั ะผะพะดะตะปั ะกะะ

ะะะะะขะ ะะะะะะะะ ะะ ะะขะกะขะฃะะซ:
- ะกััะพะบะฐ 1: 0 ะฟัะพะฑะตะปะพะฒ (mindmap)
- ะกััะพะบะฐ 2: 2 ะฟัะพะฑะตะปะฐ (ะบะพัะฝะตะฒะพะน ัะทะตะป)
- ะกััะพะบะฐ 3+: 4+ ะฟัะพะฑะตะปะพะฒ (ะฟะพะดัะตะผั)

ะะ ะะขะะะะะะฏะ ะะะ, ะะกะะ ะะ ะฃะะะะะ ะ ะะขะกะขะฃะะะฅ!` : `ะะะะะ ะะะะะ ะะขะะะะะะะ:
- ะัะพะฒะตัั, ััะพ ะบะพะด ะฝะฐัะธะฝะฐะตััั ั ะฟัะฐะฒะธะปัะฝะพะณะพ ะบะปััะตะฒะพะณะพ ัะปะพะฒะฐ (${mermaidDiagramType})
- ะฃะฑะตะดะธัั, ััะพ ะฒัะต ัะธะฝัะฐะบัะธัะตัะบะธะต ะบะพะฝััััะบัะธะธ ะฟัะฐะฒะธะปัะฝัะต
- ะัะพะฒะตัั, ััะพ ะฝะตั ะฝะตะทะฐะบััััั ัะบะพะฑะพะบ, ะบะฐะฒััะตะบ ะธะปะธ ะดััะณะธั ัะธะผะฒะพะปะพะฒ
- ะฃะฑะตะดะธัั, ััะพ ะบะพะปะธัะตััะฒะพ ัะปะตะผะตะฝัะพะฒ ัะพะพัะฒะตัััะฒัะตั ััะตะฑะพะฒะฐะฝะธัะผ ัะธะฟะฐ ะดะธะฐะณัะฐะผะผั
- ะะพะด ะดะพะปะถะตะฝ ะฑััั ะณะพัะพะฒ ะบ ัะตะฝะดะตัะธะฝะณั ะฑะตะท ะพัะธะฑะพะบ`}

\`\`\`json
[
  {"element": "ะะฐะทะฒะฐะฝะธะต ัะปะตะผะตะฝัะฐ ะฝะฐ ััััะบะพะผ", "description": "ะะฟะธัะฐะฝะธะต ัะปะตะผะตะฝัะฐ ะฝะฐ ััััะบะพะผ"},
  ...
]
\`\`\``;
    } else {
      userPrompt = `ะกะพะทะดะฐะน ${typeDescription} ะดะปั ัะปะตะดัััะตะณะพ ะพะฑัะตะบัะฐ/ะฟัะพัะตััะฐ:

${objectDescription}

ะะะะะ: ะัะต ะฝะฐะทะฒะฐะฝะธั ะพะฑัะตะบัะพะฒ, ะบะปะฐััะพะฒ, ะผะตัะพะดะพะฒ, ะฐััะธะฑััะพะฒ ะธ ะดััะณะธั ัะปะตะผะตะฝัะพะฒ ะดะพะปะถะฝั ะฑััั ะฝะฐ ััััะบะพะผ ัะทัะบะต. ะัะฟะพะปัะทัะน ััััะบะธะต ะฝะฐะทะฒะฐะฝะธั ะดะปั ะฒัะตั ัััะฝะพััะตะน (ะฝะฐะฟัะธะผะตั: "ะะฝััะธััั", "ะกััะดะตะฝั", "ะัะตะฟะพะดะฐะฒะฐัะตะปั", "ะััั" ะธ ั.ะด.). ะกะธะฝัะฐะบัะธั PlantUML ะพััะฐะตััั ะฝะฐ ะฐะฝะณะปะธะนัะบะพะผ (class, interface, ->, etc.), ะฝะพ ัะพะดะตัะถะธะผะพะต - ะฝะฐ ััััะบะพะผ.

${diagramType === 'MindMap' ? 'ะะะฏ MINDMAP: ะัะฟะพะปัะทัะน ะฟัะฐะฒะธะปัะฝัะน ัะธะฝัะฐะบัะธั @startmindmap ... @endmindmap. ะกัััะบัััะฐ: * ะฆะตะฝััะฐะปัะฝะฐั ัะตะผะฐ ** ะะพะดัะตะผะฐ 1 *** ะะพะดะฟะพะดัะตะผะฐ 1.1 ** ะะพะดัะตะผะฐ 2. ะะ ะธัะฟะพะปัะทัะน ะฟัะพััะพ "mindmap" ะฑะตะท @startmindmap/@endmindmap!' : ''}
${diagramType === 'Activity' ? 'ะะะฏ ACTIVITY: ะัะฟะพะปัะทัะน ะฟัะฐะฒะธะปัะฝัะน ัะธะฝัะฐะบัะธั activity ะดะธะฐะณัะฐะผะผั: start, :ะดะตะนััะฒะธะต;, if (ััะปะพะฒะธะต) then, else, endif, fork, fork again, end fork, stop. ะะ ะธัะฟะพะปัะทัะน split/join, ะธัะฟะพะปัะทัะน fork/fork again/end fork!' : ''}
${diagramType === 'Class' ? 'ะะะฏ CLASS: ะะปั ะดะปะธะฝะฝัั ััััะบะธั ะฝะฐะทะฒะฐะฝะธะน ะบะปะฐััะพะฒ ะธัะฟะพะปัะทัะน ะฟัะพะฑะตะปั ะธะปะธ ัะฐะทะฑะธะฒะฐะน ะฝะฐ ะฝะตัะบะพะปัะบะพ ัะปะพะฒ. ะะฐะฟัะธะผะตั: "ะคะตะดะตัะฐะปัะฝะพะต ะะพััะดะฐัััะฒะตะฝะฝะพะต ะะฑัะฐะทะพะฒะฐัะตะปัะฝะพะต ะฃััะตะถะดะตะฝะธะต" ะฒะผะตััะพ "ะคะตะดะตัะฐะปัะฝะพะตะะพััะดะฐัััะฒะตะฝะฝะพะตะะฑัะฐะทะพะฒะฐัะตะปัะฝะพะตะฃััะตะถะดะตะฝะธะต". ะัะฟะพะปัะทัะน ะบะฐะฒััะบะธ ะดะปั ะฝะฐะทะฒะฐะฝะธะน ั ะฟัะพะฑะตะปะฐะผะธ: class "ะะฐะทะฒะฐะฝะธะต ั ะฟัะพะฑะตะปะฐะผะธ" as ะะปะธะฐั' : ''}`;

      if (context) {
        userPrompt += `\n\nะะพะฟะพะปะฝะธัะตะปัะฝัะน ะบะพะฝัะตะบัั ะธะท ะดะพะบัะผะตะฝัะพะฒ:\n${context.substring(0, 3000)}`;
      }

      userPrompt += `\n\nะกะณะตะฝะตัะธััะน ะบะพะด PlantUML ะธ ะณะปะพััะฐัะธะน. ะคะพัะผะฐั ะพัะฒะตัะฐ:
\`\`\`plantuml
@startuml
[ะบะพะด ะดะธะฐะณัะฐะผะผั ั ััััะบะธะผะธ ะฝะฐะทะฒะฐะฝะธัะผะธ ะพะฑัะตะบัะพะฒ]
@enduml
\`\`\`

\`\`\`json
[
  {"element": "ะะฐะทะฒะฐะฝะธะต ัะปะตะผะตะฝัะฐ ะฝะฐ ััััะบะพะผ", "description": "ะะฟะธัะฐะฝะธะต ัะปะตะผะตะฝัะฐ ะฝะฐ ััััะบะพะผ"},
  ...
]
\`\`\``;
    }

    try {
      // ะัะทัะฒะฐะตะผ ะผะพะดะตะปั Mistral AI
      const chatResponse = await client.chat.complete({
        model: 'pixtral-12b-2409',
        messages: [
          {
            role: 'system',
            content: systemPrompt,
          },
          {
            role: 'user',
            content: userPrompt,
          },
        ],
        maxTokens: 4096,
        temperature: 0.3, // ะะธะทะบะฐั ัะตะผะฟะตัะฐัััะฐ ะดะปั ะฑะพะปะตะต ัะพัะฝะพะณะพ ะบะพะดะฐ
      });

      const responseContent = chatResponse.choices?.[0]?.message?.content;
      let responseText = '';
      if (typeof responseContent === 'string') {
        responseText = responseContent;
      } else if (Array.isArray(responseContent)) {
        responseText = responseContent
          .map(c => {
            if (typeof c === 'string') return c;
            if ('text' in c && typeof (c as any).text === 'string') return (c as any).text;
            return '';
          })
          .join('');
      } else {
        responseText = String(responseContent || '');
      }

      // ะกะฟะตัะธะฐะปัะฝะฐั ััะฝะบัะธั ะดะปั ะธัะฟัะฐะฒะปะตะฝะธั ะพััััะฟะพะฒ ะฒ MindMap
      const fixMindMapIndentation = (code: string): string => {
        const lines = code.split('\n').map(l => l.trimEnd());
        if (lines.length === 0) return 'mindmap\n  root((ะะพัะฝะตะฒะพะน ัะทะตะป))';
        
        const result: string[] = [];
        
        // ะะตัะฒะฐั ัััะพะบะฐ ะดะพะปะถะฝะฐ ะฑััั "mindmap" ะฑะตะท ะพััััะฟะพะฒ
        const firstLine = lines[0].trim();
        if (firstLine.toLowerCase() === 'mindmap' || firstLine === '') {
          result.push('mindmap');
        } else {
          result.push('mindmap');
          // ะัะปะธ ะฟะตัะฒะฐั ัััะพะบะฐ ะฝะต "mindmap", ะดะพะฑะฐะฒะปัะตะผ ะตะต ะบะฐะบ ะบะพัะฝะตะฒะพะน ัะทะตะป
          if (firstLine) {
            const rootContent = firstLine.replace(/^root\(\(|\)\)$/g, '').trim();
            result.push(`  root((${rootContent || 'ะะพัะฝะตะฒะพะน ัะทะตะป'}))`);
          }
        }
        
        // ะะฐัะพะดะธะผ ะบะพัะฝะตะฒะพะน ัะทะตะป
        let rootFound = false;
        let rootContent = '';
        let startIndex = 1;
        
        for (let i = 1; i < lines.length; i++) {
          const line = lines[i].trim();
          if (!line) continue;
          
          if (line.startsWith('root')) {
            rootContent = line.replace(/^root\(\(|\)\)$/g, '').trim();
            rootFound = true;
            startIndex = i + 1;
            break;
          } else if (!rootFound) {
            // ะะตัะฒะฐั ะฝะตะฟัััะฐั ัััะพะบะฐ ะฟะพัะปะต mindmap - ััะพ ะบะพัะฝะตะฒะพะน ัะทะตะป
            rootContent = line.replace(/^root\(\(|\)\)$/g, '').trim();
            rootFound = true;
            startIndex = i + 1;
            break;
          }
        }
        
        // ะะพะฑะฐะฒะปัะตะผ ะบะพัะฝะตะฒะพะน ัะทะตะป
        if (rootFound && rootContent) {
          result.push(`  root((${rootContent}))`);
        } else if (!rootFound) {
          result.push('  root((ะะพัะฝะตะฒะพะน ัะทะตะป))');
        }
        
        // ะะฑัะฐะฑะฐััะฒะฐะตะผ ะพััะฐะปัะฝัะต ัััะพะบะธ - ะฒัะต ะพะฝะธ ะดะพะปะถะฝั ะฑััั ะฟะพะดัะตะผะฐะผะธ (>= 4 ะฟัะพะฑะตะปะฐ)
        const contentLines: string[] = [];
        for (let i = startIndex; i < lines.length; i++) {
          const line = lines[i].trim();
          if (line && !line.startsWith('root')) {
            contentLines.push(line);
          }
        }
        
        // ะัะปะธ ะตััั ัััะพะบะธ ะฑะตะท ะพััััะฟะพะฒ ะธะปะธ ั ะผะฐะปะตะฝัะบะธะผะธ ะพััััะฟะฐะผะธ - ััะพ ะฟะตัะฒัะน ััะพะฒะตะฝั (4 ะฟัะพะฑะตะปะฐ)
        // ะัะปะธ ะตััั ัััะพะบะธ ั ะฑะพะปััะธะผะธ ะพััััะฟะฐะผะธ - ัะพััะฐะฝัะตะผ ะพัะฝะพัะธัะตะปัะฝัั ััััะบัััั
        let baseIndent = 4;
        for (const line of contentLines) {
          const originalLine = lines.find(l => l.trim() === line);
          if (originalLine) {
            const leadingSpaces = originalLine.length - originalLine.trimStart().length;
            if (leadingSpaces <= 2) {
              // ะกััะพะบะฐ ะฑะตะท ะพััััะฟะฐ ะธะปะธ ั ะผะฐะปะตะฝัะบะธะผ ะพััััะฟะพะผ - ััะพ ะฟะตัะฒัะน ััะพะฒะตะฝั
              result.push(`    ${line}`);
            } else {
              // ะกะพััะฐะฝัะตะผ ะพัะฝะพัะธัะตะปัะฝัะน ะพััััะฟ, ะฝะพ ะฝะพัะผะฐะปะธะทัะตะผ
              // ะะธะฝะธะผัะผ 4 ะฟัะพะฑะตะปะฐ, ะบัะฐัะฝะพ 2
              const normalizedIndent = Math.max(4, Math.ceil((leadingSpaces - 2) / 2) * 2 + 2);
              result.push(' '.repeat(normalizedIndent) + line);
            }
          } else {
            // ะัะปะธ ะฝะต ะฝะฐัะปะธ ะพัะธะณะธะฝะฐะปัะฝัั ัััะพะบั, ะดะพะฑะฐะฒะปัะตะผ ั ะฑะฐะทะพะฒัะผ ะพััััะฟะพะผ
            result.push(' '.repeat(baseIndent) + line);
          }
        }
        
        return result.join('\n');
      };

      // ะคัะฝะบัะธั ะดะปั ะฟะพััะพะฑัะฐะฑะพัะบะธ ะธ ะธัะฟัะฐะฒะปะตะฝะธั ะบะพะดะฐ Mermaid
      const fixMermaidCode = (code: string, diagramType: string): string => {
        let fixed = code.trim();
        
        // ะกะฟะตัะธะฐะปัะฝะฐั ะพะฑัะฐะฑะพัะบะฐ ะดะปั MindMap
        if (diagramType === 'mindmap') {
          // ะฃะดะฐะปัะตะผ ะฒัะต ะพััััะฟั ะฒ ะฝะฐัะฐะปะต ะธ ะฝะพัะผะฐะปะธะทัะตะผ
          const lines = fixed.split('\n');
          const normalized: string[] = [];
          
          for (let i = 0; i < lines.length; i++) {
            const line = lines[i].trim();
            if (!line) continue;
            
            if (i === 0) {
              // ะะตัะฒะฐั ัััะพะบะฐ ะดะพะปะถะฝะฐ ะฑััั "mindmap"
              normalized.push('mindmap');
            } else if (i === 1) {
              // ะัะพัะฐั ัััะพะบะฐ - ะบะพัะฝะตะฒะพะน ัะทะตะป ั ะพััััะฟะพะผ 2 ะฟัะพะฑะตะปะฐ
              if (line.startsWith('root')) {
                normalized.push(`  ${line}`);
              } else {
                normalized.push(`  root((${line.replace(/^root\(\(|\)\)$/g, '')}))`);
              }
            } else {
              // ะััะฐะปัะฝัะต ัััะพะบะธ - ะพะฟัะตะดะตะปัะตะผ ััะพะฒะตะฝั ะฟะพ ะฟะพะทะธัะธะธ
              const prevLine = normalized[normalized.length - 1];
              const prevIndent = prevLine.length - prevLine.trimStart().length;
              
              // ะัะปะธ ัะตะบััะฐั ัััะพะบะฐ ะฑะตะท ะพััััะฟะฐ ะธะปะธ ั ะผะฐะปะตะฝัะบะธะผ ะพััััะฟะพะผ - ััะพ ะฟะตัะฒัะน ััะพะฒะตะฝั (4 ะฟัะพะฑะตะปะฐ)
              const leadingSpaces = lines[i].length - lines[i].trimStart().length;
              if (leadingSpaces <= 2) {
                normalized.push(`    ${line}`); // 4 ะฟัะพะฑะตะปะฐ
              } else {
                // ะกะพััะฐะฝัะตะผ ะพัะฝะพัะธัะตะปัะฝัะน ะพััััะฟ, ะฝะพ ะฝะพัะผะฐะปะธะทัะตะผ ะดะพ ัะตัะฝัั ัะธัะตะป
                const normalizedIndent = Math.max(4, Math.ceil((leadingSpaces - 2) / 2) * 2 + 2);
                normalized.push(' '.repeat(normalizedIndent) + line);
              }
            }
          }
          
          fixed = normalized.join('\n');
        } else {
          // ะะปั ะดััะณะธั ัะธะฟะพะฒ ะดะธะฐะณัะฐะผะผ
          // ะฃะฑะตะถะดะฐะตะผัั, ััะพ ะบะพะด ะฝะฐัะธะฝะฐะตััั ั ะฟัะฐะฒะธะปัะฝะพะณะพ ัะธะฟะฐ ะดะธะฐะณัะฐะผะผั
          if (!fixed.startsWith(diagramType)) {
            // ะฃะดะฐะปัะตะผ ะฒะพะทะผะพะถะฝัะต ะฟัะตัะธะบัั ะธ ะดะพะฑะฐะฒะปัะตะผ ะฟัะฐะฒะธะปัะฝัะน
            fixed = fixed.replace(/^(flowchart|graph|mindmap|sequenceDiagram|classDiagram|stateDiagram|erDiagram|gantt|pie|quadrantChart|radar|timeline|journey|xychart|gitGraph|kanban|C4Context|C4Container)\s*/i, '');
            fixed = `${diagramType}\n${fixed}`;
          }
          
          // ะัะฟัะฐะฒะปัะตะผ ัะฐัะฟัะพัััะฐะฝะตะฝะฝัะต ะพัะธะฑะบะธ
          // ะฃะดะฐะปัะตะผ ะปะธัะฝะธะต ะฟัะพะฑะตะปั ะฒ ะฝะฐัะฐะปะต ัััะพะบ
          fixed = fixed.split('\n').map(line => line.trimStart()).join('\n');
          
          // ะัะฟัะฐะฒะปัะตะผ ะฝะตะทะฐะบััััะต ัะบะพะฑะบะธ ะฒ flowchart/graph (ะดะพะฑะฐะฒะปัะตะผ ะทะฐะบััะฒะฐััะธะต ัะบะพะฑะบะธ ะดะปั ัะทะปะพะฒ)
          if (diagramType.startsWith('flowchart') || diagramType.startsWith('graph')) {
            // ะฃะฑะตะถะดะฐะตะผัั, ััะพ ัะทะปั ะฟัะฐะฒะธะปัะฝะพ ะทะฐะบัััั
            fixed = fixed.replace(/(\[[^\]]*)$/gm, (match) => {
              if (!match.includes(']')) {
                return match + ']';
              }
              return match;
            });
            fixed = fixed.replace(/(\{[^\}]*)$/gm, (match) => {
              if (!match.includes('}')) {
                return match + '}';
              }
              return match;
            });
          }
        }
        
        // ะัะฟัะฐะฒะปัะตะผ ะฟัะพะฑะปะตะผั ั ะบะฐะฒััะบะฐะผะธ ะฒ ะฝะฐะทะฒะฐะฝะธัั
        // ะะฐะผะตะฝัะตะผ ะฝะตะฟัะฐะฒะธะปัะฝัะต ะบะฐะฒััะบะธ ะฝะฐ ะฟัะฐะฒะธะปัะฝัะต
        fixed = fixed.replace(/[""]/g, '"').replace(/['']/g, "'");
        
        // ะฃะดะฐะปัะตะผ ะฟััััะต ัััะพะบะธ ะฒ ะฝะฐัะฐะปะต ะธ ะบะพะฝัะต
        fixed = fixed.trim();
        
        return fixed;
      };

      // ะะทะฒะปะตะบะฐะตะผ ะบะพะด ะฒ ะทะฐะฒะธัะธะผะพััะธ ะพั ัะธะฟะฐ ะดะธะฐะณัะฐะผะผั
      if (isMermaid) {
        // ะะทะฒะปะตะบะฐะตะผ ะบะพะด Mermaid
        const mermaidMatch = responseText.match(/```mermaid\s*\n([\s\S]*?)\n```/i) ||
                           responseText.match(new RegExp(`${mermaidDiagramType}\\s*\\n([\\s\\S]*?)(?=\\n\`\`\`|$)`, 'i'));
        
        let mermaidCode = '';
        if (mermaidMatch) {
          mermaidCode = mermaidMatch[1].trim();
          
          // ะัะธะผะตะฝัะตะผ ะฟะพััะพะฑัะฐะฑะพัะบั ะดะปั ะธัะฟัะฐะฒะปะตะฝะธั ะพัะธะฑะพะบ
          mermaidCode = fixMermaidCode(mermaidCode, mermaidDiagramType);
          
          // ะะปั MindMap ะฟัะธะผะตะฝัะตะผ ะดะพะฟะพะปะฝะธัะตะปัะฝัั ะพะฑัะฐะฑะพัะบั ะพััััะฟะพะฒ
          if (mermaidDiagramType === 'mindmap' && (diagramType === 'MindMapMax' || diagramType === 'MindMapMermaid')) {
            mermaidCode = fixMindMapIndentation(mermaidCode);
          }
        } else {
          // Fallback: ัะพะทะดะฐะตะผ ะฑะฐะทะพะฒัั Mermaid ะดะธะฐะณัะฐะผะผั ะฒ ะทะฐะฒะธัะธะผะพััะธ ะพั ัะธะฟะฐ
          if (mermaidDiagramType === 'mindmap') {
            const rootNode = objectDescription.split(' ')[0] || 'ะะพัะฝะตะฒะพะน ัะทะตะป';
            mermaidCode = `mindmap
  root((${rootNode}))
    ะะพะดัะตะผะฐ 1
      ะะตัะฐะปั 1.1
    ะะพะดัะตะผะฐ 2
      ะะตัะฐะปั 2.1`;
          } else if (mermaidDiagramType === 'flowchart' || mermaidDiagramType === 'graph') {
            const nodeName = objectDescription.split(' ')[0] || 'ะญะปะตะผะตะฝั';
            mermaidCode = `${mermaidDiagramType} TD
    A[${nodeName}]
    B[ะะพะดัะปะตะผะตะฝั 1]
    C[ะะพะดัะปะตะผะตะฝั 2]
    A --> B
    A --> C`;
          } else if (mermaidDiagramType === 'pie') {
            mermaidCode = `pie title ${objectDescription.split(' ')[0] || 'ะะธะฐะณัะฐะผะผะฐ'}
    "ะญะปะตะผะตะฝั 1" : 30
    "ะญะปะตะผะตะฝั 2" : 50
    "ะญะปะตะผะตะฝั 3" : 20`;
          } else {
            mermaidCode = `${mermaidDiagramType}\n    ${objectDescription.split(' ')[0] || 'ะญะปะตะผะตะฝั'}`;
          }
          
          // ะัะธะผะตะฝัะตะผ ะฟะพััะพะฑัะฐะฑะพัะบั ะบ fallback ะบะพะดั
          mermaidCode = fixMermaidCode(mermaidCode, mermaidDiagramType);
        }

        // ะะทะฒะปะตะบะฐะตะผ ะณะปะพััะฐัะธะน
        const glossaryMatch = responseText.match(/```json\s*\n([\s\S]*?)\n```/i);
        let glossary: Array<{ element: string; description: string }> = [];
        
        if (glossaryMatch) {
          try {
            glossary = JSON.parse(glossaryMatch[1]);
          } catch (e) {
            console.error('ะัะธะฑะบะฐ ะฟะฐััะธะฝะณะฐ ะณะปะพััะฐัะธั:', e);
            glossary = [{ element: objectDescription, description: 'ะัะฝะพะฒะฝะพะน ะพะฑัะตะบั ะดะธะฐะณัะฐะผะผั' }];
          }
        } else {
          glossary = [{ element: objectDescription, description: 'ะัะฝะพะฒะฝะพะน ะพะฑัะตะบั ะดะธะฐะณัะฐะผะผั' }];
        }

        // ะะฐะปะธะดะฐัะธั ะณะปะพััะฐัะธั
        if (!Array.isArray(glossary)) {
          glossary = [{ element: objectDescription, description: 'ะัะฝะพะฒะฝะพะน ะพะฑัะตะบั ะดะธะฐะณัะฐะผะผั' }];
        }

        return NextResponse.json({
          mermaidCode,
          glossary,
        });
      } else {
        // ะะทะฒะปะตะบะฐะตะผ ะบะพะด PlantUML
        // ะะปั ัะฐะทะฝัั ัะธะฟะพะฒ ะดะธะฐะณัะฐะผะผ ะฝัะถะฝั ัะฐะทะฝัะต ัะตะณะธ
        const isMindMap = diagramType === 'MindMap';
        const isJSON = diagramType === 'JSON';
        
        const startTag = isMindMap ? '@startmindmap' : (isJSON ? '@startjson' : '@startuml');
        const endTag = isMindMap ? '@endmindmap' : (isJSON ? '@endjson' : '@enduml');
        
        const plantUmlMatch = responseText.match(/```plantuml\s*\n([\s\S]*?)\n```/i) || 
                             responseText.match(new RegExp(`${startTag}\\s*\\n([\\s\\S]*?)${endTag}`, 'i')) ||
                             responseText.match(/@startuml\s*\n([\s\S]*?)@enduml/i);
        
        let plantUmlCode = '';
        if (plantUmlMatch) {
          plantUmlCode = plantUmlMatch[1].trim();
          
          // ะฃะดะฐะปัะตะผ ะฝะตะฟัะฐะฒะธะปัะฝัะต ัะตะณะธ, ะตัะปะธ ะพะฝะธ ะตััั
          plantUmlCode = plantUmlCode.replace(/@startuml\s*/gi, '');
          plantUmlCode = plantUmlCode.replace(/@enduml\s*/gi, '');
          plantUmlCode = plantUmlCode.replace(/@startmindmap\s*/gi, '');
          plantUmlCode = plantUmlCode.replace(/@endmindmap\s*/gi, '');
          plantUmlCode = plantUmlCode.replace(/@startjson\s*/gi, '');
          plantUmlCode = plantUmlCode.replace(/@endjson\s*/gi, '');
          plantUmlCode = plantUmlCode.replace(/mindmap\s*/gi, ''); // ะฃะดะฐะปัะตะผ ะฟัะพััะพ "mindmap" ะตัะปะธ ะตััั
          plantUmlCode = plantUmlCode.replace(/split\s*/gi, 'fork'); // ะะฐะผะตะฝัะตะผ split ะฝะฐ fork ะดะปั Activity
          plantUmlCode = plantUmlCode.replace(/join\s*/gi, 'end fork'); // ะะฐะผะตะฝัะตะผ join ะฝะฐ end fork ะดะปั Activity
          
          // ะะปั Class: ะธัะฟัะฐะฒะปัะตะผ ะดะปะธะฝะฝัะต ะฝะฐะทะฒะฐะฝะธั ะบะปะฐััะพะฒ ะฑะตะท ะฟัะพะฑะตะปะพะฒ
          if (diagramType === 'Class') {
            // ะะฐะผะตะฝัะตะผ ะดะปะธะฝะฝัะต ัะปะธัะฝัะต ััััะบะธะต ัะปะพะฒะฐ ะฝะฐ ัะปะพะฒะฐ ั ะฟัะพะฑะตะปะฐะผะธ ะฒ ะบะฐะฒััะบะฐั
            plantUmlCode = plantUmlCode.replace(/class\s+([ะ-ะฏะ][ะฐ-ัั]{20,})\s+as\s+(\w+)/gi, (match, className, alias) => {
              // ะะฐะทะฑะธะฒะฐะตะผ ะดะปะธะฝะฝะพะต ัะปะพะฒะพ ะฝะฐ ัะฐััะธ (ะบะฐะถะดัะต 15-20 ัะธะผะฒะพะปะพะฒ)
              const words = className.match(/.{1,20}/g);
              const spacedName = words ? words.join(' ') : className;
              return `class "${spacedName}" as ${alias}`;
            });
            // ะขะฐะบะถะต ะพะฑัะฐะฑะฐััะฒะฐะตะผ ัะปััะฐะธ ะฑะตะท "as"
            plantUmlCode = plantUmlCode.replace(/class\s+([ะ-ะฏะ][ะฐ-ัั]{20,})\s*{/gi, (match, className) => {
              const words = className.match(/.{1,20}/g);
              const spacedName = words ? words.join(' ') : className;
              return `class "${spacedName}" {`;
            });
          }
          
          // ะะพะฑะฐะฒะปัะตะผ ะฟัะฐะฒะธะปัะฝัะต ัะตะณะธ
          if (!plantUmlCode.includes(startTag)) {
            plantUmlCode = `${startTag}\n` + plantUmlCode;
          }
          if (!plantUmlCode.includes(endTag)) {
            plantUmlCode = plantUmlCode + `\n${endTag}`;
          }
        } else {
          // ะัะปะธ ะฝะต ะฝะฐัะปะธ ะฒ markdown, ะธัะตะผ ะฝะฐะฟััะผัั
          const startIndex = responseText.indexOf(startTag);
          const endIndex = responseText.indexOf(endTag);
          if (startIndex !== -1 && endIndex !== -1) {
            plantUmlCode = responseText.substring(startIndex, endIndex + endTag.length).trim();
          } else {
            // Fallback: ัะพะทะดะฐะตะผ ะฑะฐะทะพะฒัั ะดะธะฐะณัะฐะผะผั ะฒ ะทะฐะฒะธัะธะผะพััะธ ะพั ัะธะฟะฐ
            if (isMindMap) {
              plantUmlCode = `${startTag}
* ${objectDescription.split(' ')[0]}
** ะะพะดัะตะผะฐ 1
*** ะะตัะฐะปั 1.1
** ะะพะดัะตะผะฐ 2
${endTag}`;
            } else {
              plantUmlCode = `${startTag}
class ${objectDescription.split(' ')[0]} {
  + ะพะฟะธัะฐะฝะธะต
}
${endTag}`;
            }
          }
        }

        // ะะทะฒะปะตะบะฐะตะผ ะณะปะพััะฐัะธะน
        const glossaryMatch = responseText.match(/```json\s*\n([\s\S]*?)\n```/i);
        let glossary: Array<{ element: string; description: string }> = [];
        
        if (glossaryMatch) {
          try {
            glossary = JSON.parse(glossaryMatch[1]);
          } catch (e) {
            console.error('ะัะธะฑะบะฐ ะฟะฐััะธะฝะณะฐ ะณะปะพััะฐัะธั:', e);
            // ะกะพะทะดะฐะตะผ ะฟัะพััะพะน ะณะปะพััะฐัะธะน ะฝะฐ ะพัะฝะพะฒะต ะบะพะดะฐ
            glossary = [{ element: objectDescription, description: 'ะัะฝะพะฒะฝะพะน ะพะฑัะตะบั ะดะธะฐะณัะฐะผะผั' }];
          }
        } else {
          // ะัะปะธ ะณะปะพััะฐัะธะน ะฝะต ะฝะฐะนะดะตะฝ, ัะพะทะดะฐะตะผ ะฑะฐะทะพะฒัะน
          glossary = [{ element: objectDescription, description: 'ะัะฝะพะฒะฝะพะน ะพะฑัะตะบั ะดะธะฐะณัะฐะผะผั' }];
        }

        // ะะฐะปะธะดะฐัะธั ะณะปะพััะฐัะธั
        if (!Array.isArray(glossary)) {
          glossary = [{ element: objectDescription, description: 'ะัะฝะพะฒะฝะพะน ะพะฑัะตะบั ะดะธะฐะณัะฐะผะผั' }];
        }

        return NextResponse.json({
          plantUmlCode,
          glossary,
        });
      }
    } catch (apiError) {
      console.error('ะัะธะฑะบะฐ ะฟัะธ ะฒัะทะพะฒะต Mistral AI API:', apiError);
      return NextResponse.json(
        { error: `ะัะธะฑะบะฐ ะฟัะธ ะณะตะฝะตัะฐัะธะธ ะดะธะฐะณัะฐะผะผั: ${apiError instanceof Error ? apiError.message : 'ะะตะธะทะฒะตััะฝะฐั ะพัะธะฑะบะฐ'}` },
        { status: 500 }
      );
    }
  } catch (error) {
    console.error('ะัะธะฑะบะฐ ะฟัะธ ะพะฑัะฐะฑะพัะบะต ะทะฐะฟัะพัะฐ ะณะตะฝะตัะฐัะธะธ ะดะธะฐะณัะฐะผะผั:', error);
    return NextResponse.json(
      { error: error instanceof Error ? error.message : 'ะัะธะฑะบะฐ ะฟัะธ ะพะฑัะฐะฑะพัะบะต ะทะฐะฟัะพัะฐ' },
      { status: 500 }
    );
  }
}

